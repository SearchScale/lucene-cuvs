"""Buildfile for cuvs."""

load(
    "@lucene-cuvs//thirdparty:global_defs.bzl",
    "LUCENE_CUVS_GLOBAL_COMPILE_FLAGS",
    "LUCENE_CUVS_GLOBAL_DEFINES",
    "LUCENE_CUVS_OFFLOAD_SM89",
)
load("@rules_ll//ll:defs.bzl", "ll_library")

ll_library(
    name = "cuvs",
    compile_flags = LUCENE_CUVS_GLOBAL_COMPILE_FLAGS + LUCENE_CUVS_OFFLOAD_SM89,
    hdrs = glob([
        "cpp/src/**/*.cuh",
        "cpp/src/**/*.h",
    ]),
    experimental_device_intrinsics = [
        "@raft//:cpp/scripts/__clang_cuda_additional_intrinsics.h",
    ],
    exposed_hdrs = glob(["cpp/include/**/*"]),
    exposed_angled_includes = ["cpp/include"],
    includes = ["cpp/src/distance/detail"],
    compilation_mode = "cuda_nvptx_nvcc",
    visibility = ["//visibility:public"],
    defines = LUCENE_CUVS_GLOBAL_DEFINES,
    deps = [
        "@raft",
        "@rmm",
        "@spdlog",
        "@fmt",
        "@cutlass",
        "@cutlass//:cute",
        "@cccl//:libcudacxx",
        "@cccl//:cub",
        "@cccl//:thrust",
    ],
    # TODO(aaronmondal): Make all of these compile.
    srcs = [
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_canberra_double_double_double_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_canberra_float_float_float_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_correlation_double_double_double_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_correlation_float_float_float_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_cosine_double_double_double_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_cosine_float_float_float_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_hamming_unexpanded_double_double_double_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_hamming_unexpanded_float_float_float_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_hellinger_expanded_double_double_double_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_hellinger_expanded_float_float_float_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_jensen_shannon_double_double_double_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_jensen_shannon_float_float_float_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_kl_divergence_double_double_double_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_kl_divergence_float_float_float_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_l1_double_double_double_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_l1_float_float_float_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_l2_expanded_double_double_double_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_l2_expanded_float_float_float_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_l2_unexpanded_double_double_double_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_l2_unexpanded_float_float_float_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_l_inf_double_double_double_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_l_inf_float_float_float_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_lp_unexpanded_double_double_double_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_lp_unexpanded_float_float_float_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_rbf.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_russel_rao_double_double_double_int.cu",
        # "cpp/src/distance/detail/pairwise_matrix/dispatch_russel_rao_float_float_float_int.cu",
        # "cpp/src/distance/distance.cu",
        # "cpp/src/distance/pairwise_distance.cu",
        # "cpp/src/neighbors/brute_force_index.cu",
        # "cpp/src/neighbors/brute_force.cu",
        "cpp/src/neighbors/cagra_build_float.cpp",
        "cpp/src/neighbors/cagra_build_int8.cpp",
        "cpp/src/neighbors/cagra_build_uint8.cpp",
        "cpp/src/neighbors/cagra_optimize.cpp",
        "cpp/src/neighbors/cagra_search_float.cpp",
        "cpp/src/neighbors/cagra_search_int8.cpp",
        "cpp/src/neighbors/cagra_search_uint8.cpp",
        "cpp/src/neighbors/cagra_serialize_float.cpp",
        "cpp/src/neighbors/cagra_serialize_int8.cpp",
        "cpp/src/neighbors/cagra_serialize_uint8.cpp",
        "cpp/src/neighbors/ivf_flat_index.cpp",
        "cpp/src/neighbors/ivf_flat/ivf_flat_build_float_int64_t.cpp",
        "cpp/src/neighbors/ivf_flat/ivf_flat_build_int8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_flat/ivf_flat_build_uint8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_flat/ivf_flat_extend_float_int64_t.cpp",
        "cpp/src/neighbors/ivf_flat/ivf_flat_extend_int8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_flat/ivf_flat_extend_uint8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_flat/ivf_flat_search_float_int64_t.cpp",
        "cpp/src/neighbors/ivf_flat/ivf_flat_search_int8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_flat/ivf_flat_search_uint8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_flat/ivf_flat_serialize_float_int64_t.cpp",
        "cpp/src/neighbors/ivf_flat/ivf_flat_serialize_int8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_flat/ivf_flat_serialize_uint8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_pq_index.cpp",
        "cpp/src/neighbors/ivf_pq/ivf_pq_build_float_int64_t.cpp",
        "cpp/src/neighbors/ivf_pq/ivf_pq_build_int8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_pq/ivf_pq_build_uint8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_pq/ivf_pq_extend_float_int64_t.cpp",
        "cpp/src/neighbors/ivf_pq/ivf_pq_extend_int8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_pq/ivf_pq_extend_uint8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_pq/ivf_pq_search_float_int64_t.cpp",
        "cpp/src/neighbors/ivf_pq/ivf_pq_search_int8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_pq/ivf_pq_search_uint8_t_int64_t.cpp",
        "cpp/src/neighbors/ivf_pq_serialize.cpp",
    ],
)
